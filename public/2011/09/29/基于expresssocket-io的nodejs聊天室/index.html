<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>基于express+socket.io的nodejs聊天室 - 三水清</title>
  <meta name="author" content="三水清">
  
  <meta name="description" content="前几天晚上边看水浒边写的nodejs的聊天室，前面说了，放假之前要把近日学习nodejs的所有心得整理下，今天就是30号鸟~撒欢~，最后放这个聊天室出来给大家作为学习nodejs的参考示例，希望对大家有用。
感谢：cnodejs群里的老雷，及其微博上的基友们！顺祝大家长假快乐，顺祝自己明天动车不出轨，顺祝明年不再过节，感慨多了……
特点
聊天室主要功能及其特点：

采用nodejs（屁话）
express框架,jade做模板
socket.io做前后端的websocket通信
支持session
支持@私信功能废话不多说了，注意点，基本前面的文章都提到了，下面罗列下：《配置nodejs.exe的windows目录结构》《安装express及配置app.js文件》《使用socket.io和node.js搭建websocket应用》《在Express和Socket.IO中使用session》

nodejs聊天室下载地址
基于express+socket.io的聊天室
聊天室服务器端js代码">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="基于express+socket.io的nodejs聊天室"/>
  <meta property="og:site_name" content="三水清"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="atom.xml" title="三水清" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">三水清</a></h1>
  <h2><a href="/">专注前端开发,分享Javascript/CSS/PHP等Web前端开发技巧</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">首页</a></li>
    
      <li><a href="/about">关于</a></li>
    
      <li><a href="https://github.com/ksky521">Github</a></li>
    
      <li><a href="http://weibo.com/sanshuiqing">新浪微博</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon icon-black"></div>
      
      
  
    <h1 class="title">基于express+socket.io的nodejs聊天室</h1>
  

      <time datetime="2011-09-29T15:20:24.000Z"><a href="/2011/09/29/基于expresssocket-io的nodejs聊天室/">2011年9月29日</a></time>
    </header>
    <div class="entry">
      
        <p>前几天晚上边看水浒边写的<a href="http://js8.in/tag/nodejs">nodejs</a>的聊天室，前面说了，放假之前要把近日学习nodejs的所有心得整理下，今天就是30号鸟~撒欢~，最后放这个聊天室出来给大家作为学习<strong>nodejs</strong>的参考示例，希望对大家有用。</p>
<p>感谢：cnodejs群里的老雷，及其<a href="http://weibo.com/sanshuiqing" target="_blank">微博</a>上的基友们！顺祝大家长假快乐，顺祝自己明天动车不出轨，顺祝明年不再过节，感慨多了……</p>
<h3>特点</h3>
<p>聊天室主要功能及其特点：</p>
<ol>
<li>采用nodejs（屁话）</li>
<li>express框架,jade做模板</li>
<li>socket.io做前后端的websocket通信</li>
<li>支持session</li>
<li>支持@私信功能<br>废话不多说了，注意点，基本前面的文章都提到了，下面罗列下：<br>《<a href="http://js8.in/764.html">配置nodejs.exe的windows目录结构</a>》<br>《<a href="http://js8.in/774.html">安装express及配置app.js文件</a>》<br>《<a href="http://js8.in/784.html">使用socket.io和node.js搭建websocket应用</a>》<br>《<a href="http://js8.in/788.html">在Express和Socket.IO中使用session</a>》</li>
</ol>
<h3>nodejs聊天室下载地址</h3>
<p><a href="http://1.nodejsdemo.sinaapp.com/chat/chat.zip" title="基于express+socket.io的聊天室" target="_blank">基于express+socket.io的聊天室</a></p>
<h3>聊天室服务器端js代码</h3>
<p><a id="more"></a></p>
<figure class="highlight lang-javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
</pre></td><td class="code"><pre><span class="comment">//========================变量定义===============================</span>
<span class="comment">/**
 * modules引入
 */</span>
<span class="keyword">var</span> express = require(<span class="string">'express'</span>),
	sio = require(<span class="string">'socket.io'</span>),
	fs=require(<span class="string">'fs'</span>),
	path = require(<span class="string">'path'</span>)
	url = require(<span class="string">'url'</span>),
	parseCookie = require(<span class="string">'connect'</span>).utils.parseCookie,
	MemoryStore = require(<span class="string">'connect/middleware/session/memory'</span>);

<span class="comment">/**
 * 私人聊天使用session
 */</span>
<span class="keyword">var</span> usersWS = {}, <span class="comment">//私人聊天用的websocket</span>
	storeMemory = <span class="keyword">new</span> MemoryStore({
		reapInterval: <span class="number">60000</span> * <span class="number">10</span>
	});<span class="comment">//session store</span>
<span class="comment">//=========================app配置=============================</span>
<span class="comment">/**
 * app配置
 */</span>
<span class="keyword">var</span> app = module.export = express.createServer();

app.configure(<span class="keyword">function</span>(){
	app.use(express.bodyParser());
	app.use(express.cookieParser());
	app.use(express.session({
		secret: <span class="string">'wyq'</span>,
		store:storeMemory
	}));
	app.use(express.methodOverride());
	app.use(app.router);<span class="comment">//要放在bodyParser之后，处理post</span>
	app.set(<span class="string">'views'</span>, __dirname + <span class="string">'/views'</span>);
	app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);
	app.use(express.static(__dirname + <span class="string">'/public'</span>));
});
<span class="comment">//=================配置socket.io=========================</span>
<span class="comment">/**
 * 配置socket.io
 *
 */</span>
<span class="keyword">var</span> io = sio.listen(app);
<span class="comment">//设置session</span>
io.set(<span class="string">'authorization'</span>, <span class="keyword">function</span>(handshakeData, callback){
	<span class="comment">// 通过客户端的cookie字符串来获取其session数据</span>
	handshakeData.cookie = parseCookie(handshakeData.headers.cookie)
	<span class="keyword">var</span> connect_sid = handshakeData.cookie[<span class="string">'connect.sid'</span>];

	<span class="keyword">if</span> (connect_sid) {
		storeMemory.get(connect_sid, <span class="keyword">function</span>(error, session){
			<span class="keyword">if</span> (error) {
				<span class="comment">// if we cannot grab a session, turn down the connection</span>
				callback(error.message, <span class="literal">false</span>);
			}
			<span class="keyword">else</span> {
				<span class="comment">// save the session data and accept the connection</span>
				handshakeData.session = session;
				callback(<span class="literal">null</span>, <span class="literal">true</span>);
			}
		});
	}
	<span class="keyword">else</span> {
		callback(<span class="string">'nosession'</span>);
	}
});
<span class="comment">//=========================URL=============================</span>
<span class="comment">/**
 * url处理开始鸟~
 * @param {Object} req
 * @param {Object} res
 */</span>
app.get(<span class="string">'/'</span>,<span class="keyword">function</span>(req,res){

	<span class="keyword">if</span>( req.session.name && req.session.name!==<span class="string">''</span>){
		<span class="comment">//需要判断下是否已经登录</span>
		res.redirect(<span class="string">'/chat'</span>);
	}<span class="keyword">else</span>{
		<span class="comment">//读取登录页面，要求登录</span>
		<span class="keyword">var</span> realpath = __dirname + <span class="string">'/views/'</span> + url.parse(<span class="string">'login.html'</span>).pathname;
		<span class="keyword">var</span> txt = fs.readFileSync(realpath);
		res.end(txt);
	}
});
app.get(<span class="string">'/chat'</span>,<span class="keyword">function</span>(req,res){
	<span class="keyword">if</span> (req.session.name && req.session.name !== <span class="string">''</span>) {
		<span class="comment">//需要判断下是否已经登录</span>
		res.render(<span class="string">'chat'</span>,{name:req.session.name});
	}<span class="keyword">else</span>{
		res.redirect(<span class="string">'/'</span>);
	}
})
app.post(<span class="string">'/chat'</span>,<span class="keyword">function</span>(req,res){
	<span class="keyword">var</span> name = req.body.nick;
	<span class="keyword">if</span>(name && name!==<span class="string">''</span>){
		req.session.name = name;<span class="comment">//设置session</span>
		res.render(<span class="string">'chat'</span>,{name:name});
	}<span class="keyword">else</span>{
		res.end(<span class="string">'nickname cannot null'</span>);
	}

});

<span class="comment">//===================socket链接监听=================</span>
<span class="comment">/**
 * 开始socket链接监听
 * @param {Object} socket
 */</span>
io.sockets.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(socket)</span>{</span>
	<span class="keyword">var</span> session = socket.handshake.session;<span class="comment">//session</span>
	<span class="keyword">var</span> name = session.name;
	usersWS[name] = socket;
	<span class="keyword">var</span> refresh_online = <span class="keyword">function</span>(){
		<span class="keyword">var</span> n = [];
		<span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> usersWS){
			n.push(i);
		}
		io.sockets.emit(<span class="string">'online list'</span>, n);<span class="comment">//所有人广播</span>
	}
	refresh_online();

	socket.broadcast.emit(<span class="string">'system message'</span>, <span class="string">'【'</span>+name + <span class="string">'】回来了，大家赶紧去找TA聊聊~~'</span>);

	<span class="comment">//公共信息</span>
	socket.on(<span class="string">'public message'</span>,<span class="keyword">function</span>(msg, fn){
		socket.broadcast.emit(<span class="string">'public message'</span>, name, msg);
		fn(<span class="literal">true</span>);
	});
	<span class="comment">//私人@信息</span>
	socket.on(<span class="string">'private message'</span>,<span class="keyword">function</span>(to, msg, fn){
		<span class="keyword">var</span> target = usersWS[to];
		<span class="keyword">if</span> (target) {
			fn(<span class="literal">true</span>);
			target.emit(<span class="string">'private message'</span>, name+<span class="string">'[私信]'</span>, msg);
		}
		<span class="keyword">else</span> {
			fn(<span class="literal">false</span>)
			socket.emit(<span class="string">'message error'</span>, to, msg);
		}
	});

	<span class="comment">//掉线，断开链接处理</span>
	socket.on(<span class="string">'disconnect'</span>, <span class="keyword">function</span>(){
		<span class="keyword">delete</span> usersWS[name];
		session = <span class="literal">null</span>;
		socket.broadcast.emit(<span class="string">'system message'</span>, <span class="string">'【'</span>+name + <span class="string">'】无声无息地离开了。。。'</span>);
		refresh_online();
	});

});

<span class="comment">//===========app listen 开始鸟~==========</span>
app.listen(<span class="number">3000</span>, <span class="keyword">function</span>(){
	<span class="keyword">var</span> addr = app.address();
	console.log(<span class="string">'app listening on http://127.0.0.1：'</span> + addr.port);
});
</pre></td></tr></table></figure>


      
    </div>
    <footer>
      
        


<div class="articletags clearfix">
	<i class="icon-tag"></i>Tags: <a href="/tags/nodejs/">nodejs</a>
	<i class="icon-folder"></i>categories:  <a href="/categories/前端开发/">前端开发</a>
</div>


        
<div id="bdshare" class="bdshare_t bds_tools get-codes-bdshare">
<span class="bds_more">分享到：</span>
<a class="bds_tsina">新浪微博</a>
<a class="bds_qzone">QQ空间</a>
<a class="bds_tqq">腾讯微博</a>
<a class="bds_renren">人人网</a>
<a class="bds_douban">豆瓣网</a>
<a class="bds_bdhome">百度首页</a>
<a class="bds_youdao">有道云笔记</a>
<a class="bds_copy">复制网址</a>
</div>
<script>
var bds_config = {
    wbUid:'2037334587',
    tsina: '61439547',
    pic:''
};
</script>



        <div class="pagepart clearfix">
 
	<a href="/2011/10/18/html5的sessionstorage和localstorage/" class="prev" title="HTMl5的sessionStorage和localStorage">HTMl5的sessionStorage和localStorage</a>
 
 
	<a href="/2011/09/29/在express和socket-io中使用session/" class="next" title="在Express和Socket.IO中使用session">在Express和Socket.IO中使用session</a>
 
</div>
      
      
<div class="border"></div>
<section class="comment">
    <p class="title ico-comment">文章评论<a name="comments"></a></p>
    <div class="ds-thread" data-title="基于express+socket.io的nodejs聊天室"></div>
</section>


      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/乱七八糟/">乱七八糟</a><small>30</small></li>
  
    <li><a href="/categories/前端开发/">前端开发</a><small>117</small></li>
  
    <li><a href="/categories/后端运维/">后端运维</a><small>27</small></li>
  
    <li><a href="/categories/王婆卖瓜/">王婆卖瓜</a><small>4</small></li>
  
    <li><a href="/categories/读书笔记/">读书笔记</a><small>5</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签</h3>
  <ul class="entry clearfix">
  
    <li><a href="/tags/DOM/">DOM<sup>2</sup></a></li>
  
    <li><a href="/tags/IE/">IE<sup>1</sup></a></li>
  
    <li><a href="/tags/IE6/">IE6<sup>2</sup></a></li>
  
    <li><a href="/tags/PPT/">PPT<sup>3</sup></a></li>
  
    <li><a href="/tags/VPS/">VPS<sup>1</sup></a></li>
  
    <li><a href="/tags/ajax/">ajax<sup>5</sup></a></li>
  
    <li><a href="/tags/apache/">apache<sup>1</sup></a></li>
  
    <li><a href="/tags/audio/">audio<sup>2</sup></a></li>
  
    <li><a href="/tags/a标签/">a标签<sup>1</sup></a></li>
  
    <li><a href="/tags/canvas/">canvas<sup>1</sup></a></li>
  
    <li><a href="/tags/chrome/">chrome<sup>3</sup></a></li>
  
    <li><a href="/tags/css/">css<sup>15</sup></a></li>
  
    <li><a href="/tags/eAccelerator/">eAccelerator<sup>1</sup></a></li>
  
    <li><a href="/tags/ecmascript/">ecmascript<sup>3</sup></a></li>
  
    <li><a href="/tags/escape/">escape<sup>1</sup></a></li>
  
    <li><a href="/tags/event/">event<sup>1</sup></a></li>
  
    <li><a href="/tags/express/">express<sup>1</sup></a></li>
  
    <li><a href="/tags/fis/">fis<sup>1</sup></a></li>
  
    <li><a href="/tags/fisp/">fisp<sup>1</sup></a></li>
  
    <li><a href="/tags/grunt/">grunt<sup>1</sup></a></li>
  
    <li><a href="/tags/handleEvent/">handleEvent<sup>1</sup></a></li>
  
    <li><a href="/tags/html5/">html5<sup>3</sup></a></li>
  
    <li><a href="/tags/iframe/">iframe<sup>1</sup></a></li>
  
    <li><a href="/tags/iptables/">iptables<sup>1</sup></a></li>
  
    <li><a href="/tags/javascript/">javascript<sup>79</sup></a></li>
  
    <li><a href="/tags/linux/">linux<sup>4</sup></a></li>
  
    <li><a href="/tags/livereload/">livereload<sup>1</sup></a></li>
  
    <li><a href="/tags/memcached/">memcached<sup>1</sup></a></li>
  
    <li><a href="/tags/mixjs/">mixjs<sup>1</sup></a></li>
  
    <li><a href="/tags/mysql/">mysql<sup>2</sup></a></li>
  
    <li><a href="/tags/name/">name<sup>1</sup></a></li>
  
    <li><a href="/tags/nginx/">nginx<sup>2</sup></a></li>
  
    <li><a href="/tags/nodejs/">nodejs<sup>7</sup></a></li>
  
    <li><a href="/tags/php/">php<sup>19</sup></a></li>
  
    <li><a href="/tags/session/">session<sup>1</sup></a></li>
  
    <li><a href="/tags/storage/">storage<sup>1</sup></a></li>
  
    <li><a href="/tags/svn/">svn<sup>1</sup></a></li>
  
    <li><a href="/tags/this/">this<sup>1</sup></a></li>
  
    <li><a href="/tags/ueditor/">ueditor<sup>1</sup></a></li>
  
    <li><a href="/tags/uglifyjs/">uglifyjs<sup>1</sup></a></li>
  
    <li><a href="/tags/webbench/">webbench<sup>1</sup></a></li>
  
    <li><a href="/tags/websocket/">websocket<sup>1</sup></a></li>
  
    <li><a href="/tags/web前端开发/">web前端开发<sup>5</sup></a></li>
  
    <li><a href="/tags/windows7技巧/">windows7技巧<sup>1</sup></a></li>
  
    <li><a href="/tags/wordpress/">wordpress<sup>3</sup></a></li>
  
    <li><a href="/tags/xss/">xss<sup>3</sup></a></li>
  
    <li><a href="/tags/严格模式/">严格模式<sup>1</sup></a></li>
  
    <li><a href="/tags/位运算/">位运算<sup>1</sup></a></li>
  
    <li><a href="/tags/作用域/">作用域<sup>3</sup></a></li>
  
    <li><a href="/tags/前端优化/">前端优化<sup>1</sup></a></li>
  
    <li><a href="/tags/前端工具/">前端工具<sup>5</sup></a></li>
  
    <li><a href="/tags/加速器/">加速器<sup>1</sup></a></li>
  
    <li><a href="/tags/压力测试/">压力测试<sup>1</sup></a></li>
  
    <li><a href="/tags/右键/">右键<sup>1</sup></a></li>
  
    <li><a href="/tags/安全/">安全<sup>1</sup></a></li>
  
    <li><a href="/tags/性能/">性能<sup>3</sup></a></li>
  
    <li><a href="/tags/我也八卦/">我也八卦<sup>1</sup></a></li>
  
    <li><a href="/tags/执行环境/">执行环境<sup>1</sup></a></li>
  
    <li><a href="/tags/技巧/">技巧<sup>1</sup></a></li>
  
    <li><a href="/tags/播放器/">播放器<sup>1</sup></a></li>
  
    <li><a href="/tags/数组/">数组<sup>1</sup></a></li>
  
    <li><a href="/tags/标签/">标签<sup>1</sup></a></li>
  
    <li><a href="/tags/模块化/">模块化<sup>2</sup></a></li>
  
    <li><a href="/tags/算法/">算法<sup>1</sup></a></li>
  
    <li><a href="/tags/网络技术/">网络技术<sup>73</sup></a></li>
  
    <li><a href="/tags/虚拟主机/">虚拟主机<sup>1</sup></a></li>
  
    <li><a href="/tags/解耦/">解耦<sup>1</sup></a></li>
  
    <li><a href="/tags/语法限制/">语法限制<sup>1</sup></a></li>
  
    <li><a href="/tags/跨域/">跨域<sup>3</sup></a></li>
  
    <li><a href="/tags/路径/">路径<sup>1</sup></a></li>
  
    <li><a href="/tags/软件心得/">软件心得<sup>3</sup></a></li>
  
  </ul>
</div>



  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 三水清
  
</div>
<div class="clearfix"></div></footer>
  <script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


    
        <script type="text/javascript" id="bdshare_js" data="type=tools&amp;uid=6635976" ></script>
        <script type="text/javascript" id="bdshell_js"></script>
        <script type="text/javascript">
        document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);
        </script>
    
    
    <script type="text/javascript">
        var duoshuoQuery = {short_name:"ksky521"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'http://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0]
            || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




    <script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F1c76f5cc8274a56106b13b9c9b1fb046' type='text/javascript'%3E%3C/script%3E"));
    </script>


</body>
</html>